<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VBDB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/styles.css">
</head>

<body>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main -->
    <div class="container mt-5">

        <!-- Nav Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="vbdb-tab" data-bs-toggle="tab" data-bs-target="#vbdb" type="button"
                    role="tab" aria-controls="vbdb" aria-selected="true">VBDB</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="live-tab" data-bs-toggle="tab" data-bs-target="#live" type="button"
                    role="tab" aria-controls="live" aria-selected="false">Live</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button"
                    role="tab" aria-controls="schedule" aria-selected="false">Results</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button"
                    role="tab" aria-controls="teams" aria-selected="false">Teams</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rankings-tab" data-bs-toggle="tab" data-bs-target="#rankings" type="button"
                    role="tab" aria-controls="rankings" aria-selected="false">Rankings</button>
            </li>
        </ul>

        <!-- Main Div for tabs content -->
        <div class="tab-content" id="myTabContent">

            <!-- Home tab -->
            <div class="tab-pane fade show active" id="vbdb" role="tabpanel" aria-labelledby="vbdb-tab">
                <h2 class="text-center">VBDB Content</h2>
                <p class="text-center">Welcome to VBDB!</p>
                <p class="text-center">A focus on D1 NCAA Womens Volleyball!</p>
                <h2 class="text-center">Data Sources</h2>
                <p class="text-center">https://stats.ncaa.org</p>
                <p class="text-center">https://ncaastats.figstats.net/volleyball-rpi.cgi</p>
            </div>

            <!-- Live tab -->
            <div class="tab-pane fade" id="live" role="tabpanel" aria-labelledby="live-tab">
                <h2 class="text-center">Live Scores</h2>
                <!-- Dropdown for Searchs -->
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="conference-live-dropdown"
                                id="conference-live-dropdown">
                                <option value="Conference">Conference</option>
                            </select>
                        </div>
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="teams-live-dropdown"
                                id="teams-live-dropdown">
                                <option selected>School</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive" style="overflow-x: auto;">
                    <table id="liveTable" class="table table-dark table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Match</th>
                                <th>Results</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- We'll fill this with rows of data from the CSV -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Results tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                <h2 class="text-center">Results 2024</h2>

                <!-- Dropdown for Searchs -->
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="conference-schedule-dropdown"
                                id="conference-schedule-dropdown">
                                <option value="Conference">Conference</option>
                            </select>
                        </div>
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="teams-schedule-dropdown"
                                id="teams-schedule-dropdown">
                                <option selected>School</option>
                            </select>
                        </div>
                        <div class="col-auto mb-3">
                            <input id="startDate" class="form-control form-select-sm" type="date" />
                            <span id="startDateSelected"></span>
                        </div>
                        <div class="col-auto mb-3">
                            <input id="endDate" class="form-control form-select-sm" type="date" />
                            <span id="endDateSelected"></span>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive" style="overflow-x: auto;">
                    <table id="schTable" class="table table-dark table-hover table-striped w-100">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Match</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- CSV Portion -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Teams tab -->
            <div class="tab-pane fade" id="teams" role="tabpanel" aria-labelledby="teams-tab">
                <h2 class="text-center">NCAA D1 Schools</h2>
                <div class="text-center">
                    <a href="https://raw.githubusercontent.com/widbuntu/vbdb-info/main/data/teams.csv"
                        style="color: white; text-decoration: none;" target="_blank">
                        <caption>https://raw.githubusercontent.com/widbuntu/vbdb-info/main/data/teams.csv</caption>
                    </a>
                </div>
                <div class="table-responsive">
                    <table id="teamsTable" class="table table-dark table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>Conference</th>
                                <th>School URL</th>
                                <th>Conference Full</th>
                                <th>Division</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Fill this with rows of data from the CSV -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Rankings tab -->
            <div class="tab-pane fade" id="rankings" role="tabpanel" aria-labelledby="rankings-tab">
                <h2 class="text-center">Rankings Content</h2>
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="conference-ranking-dropdown"
                                id="conference-ranking-dropdown">
                                <option value="">All Conferences</option>
                            </select>
                        </div>
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="teams-ranking-dropdown"
                                id="teams-ranking-dropdown" disabled>
                                <option value="">All Teams</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="overflow-x: auto;">
                    <table id="rankingsTable" class="table table-dark table-hover table-striped w-100">
                        <thead>
                            <tr>
                                <th>RPI</th>
                                <th>Team</th>
                                <th>Conf</th>
                                <th>RpiPct</th>
                                <th>W-L</th>
                                <th>Top25</th>
                                <th>Top50</th>
                                <th>ConfRec</th>
                                <th>NConf</th>
                                <th>OppRcrd</th>
                                <th>SosPct</th>
                                <th>Rnk</th>
                                <th>Home</th>
                                <th>Away</th>
                                <th>Neut</th>
                                <th>Tp100</th>
                                <th>100-2</th>
                                <th>200-</th>
                                <th>SetsWon</th>
                                <th>GdW</th>
                                <th>BdL</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- CSV Portion -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- End of content -->
        </div>
    </div>

    <!-- Scripts -->

    <!-- Script to populate dropdowns -->
    <script>
        let teamData = []; // To store the team data
        let scheduleData = []; // Store schedule data


        // Function to split a line, accounting for quoted fields
        function splitLine(line) {
            const result = [];
            let currentField = '';
            let inQuotes = false;

            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes; // Toggle quote state
                } else if (char === ',' && !inQuotes) {
                    result.push(currentField.trim()); // Push field and reset
                    currentField = '';
                } else {
                    currentField += char; // Accumulate characters in current field
                }
            }

            result.push(currentField.trim()); // Push the last field
            return result;
        }

        async function fetchData() {
            const response = await fetch('https://raw.githubusercontent.com/widbuntu/vbdb-info/main/data/teams2.csv');
            const csvText = await response.text();

            // Split the CSV into rows
            const rows = csvText.split('\n');
            const dataRows = rows.slice(1); // Data rows (ignoring the header)

            const conferenceNames = new Set(); // Use a Set to store unique conference names

            // Parse each data row
            dataRows.forEach(row => {
                const fields = splitLine(row); // Use splitLine to correctly parse each row

                if (fields.length >= 6) { // Ensure we have all required columns
                    const conferenceName = fields[1]; // Full conference name (column index 2)
                    const teamShort = fields[5]; // team_short (column index 5)

                    if (conferenceName) conferenceNames.add(conferenceName);

                    // Store team data in an object
                    teamData.push({
                        teamShort: teamShort.trim(), conferenceName: conferenceName.trim(),
                    });
                }
            });

            // Populate the conference dropdown
            const sortedConferenceNames = Array.from(conferenceNames).sort();
            const dropdown = document.getElementById('conference-schedule-dropdown');

            sortedConferenceNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name; // Set the value to conference name for easy access later
                option.textContent = name;
                dropdown.appendChild(option);
            });

            populateTeamsDropdown('Conference');
        }

        function populateTeamsDropdown(conferenceName) {
            const teamsDropdown = document.getElementById('teams-schedule-dropdown');
            teamsDropdown.innerHTML = '<option selected>School</option>'; // Reset the dropdown

            const uniqueTeams = new Set(); // Use a Set to store unique team_short values

            // Filter team data based on selected conference, or show all teams if "Conference" is selected
            teamData.forEach(team => {
                if (conferenceName === "Conference" || team.conferenceName === conferenceName) {
                    uniqueTeams.add(team.teamShort);
                }
            });

            // Populate the teams dropdown with unique values
            uniqueTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamsDropdown.appendChild(option);
            });
        }

        document.getElementById('conference-schedule-dropdown').addEventListener('change', (event) => {
            const selectedConference = event.target.value;
            if (selectedConference) {
                populateTeamsDropdown(selectedConference);
            } else {
                // Reset the teams dropdown if no conference is selected
                document.getElementById('teams-schedule-dropdown').innerHTML = '<option selected>School</option>';
            }
        });

        // Fetch the data when the page loads
        fetchData();
    </script>

    <!-- Script to populate Results table -->
    <script>

        async function fetchScheduleData() {
            const response = await fetch('https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/test_sch.csv');
            const csvText = await response.text();
            const rows = csvText.split('\n').filter(row => row.trim() !== '');
            const dataRows = rows.slice(1);
            scheduleData = dataRows.map(row => {
                const fields = splitLine(row);
                return {
                    date: fields[0] || '',
                    match: fields[1] || '',
                    results: fields[2] || '',
                    box_score_url: fields[3] || ''
                };
            });
            console.log('Schedule Data:', scheduleData);
            populateScheduleTable(scheduleData);
            populateDropdowns();
        }

        function populateScheduleTable(data) {
            const tbody = document.querySelector('#schTable tbody');
            tbody.innerHTML = '';
            data.sort((a, b) => new Date(a.date) - new Date(b.date));
            data.forEach(row => {
                const rowElement = document.createElement('tr');
                rowElement.innerHTML = `
            <td style="width:5%">${row.date.trim()}</td>
            <td style="width:15%">${row.match.trim()}</td>
            <td style="width:25%">${row.results.trim()} <a href="${row.box_score_url.trim()}" target="_blank">View</a></td>
        `;
                tbody.appendChild(rowElement);
            });
        }

        function populateDropdowns() {
            const conferenceDropdown = document.getElementById('conference-schedule-dropdown');
            const teamDropdown = document.getElementById('teams-schedule-dropdown');

            const conferences = [...new Set(scheduleData.map(item => item.match.split(' vs ')[0].split(' (')[0].trim()))].sort();
            const teams = [...new Set(scheduleData.flatMap(item => item.match.split(' vs ').map(team => team.split(' (')[0].trim())))].sort();

            conferences.forEach(conf => {
                const option = document.createElement('option');
                option.value = conf;
                option.textContent = conf;
                conferenceDropdown.appendChild(option);
            });

            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamDropdown.appendChild(option);
            });
        }

        function filterTable() {
            const selectedConference = document.getElementById('conference-schedule-dropdown').value;
            const selectedTeam = document.getElementById('teams-schedule-dropdown').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const filteredData = scheduleData.filter(row => {
                const match = row.match.toLowerCase();
                const selectedConferenceTrimmed = selectedConference.toLowerCase().trim();
                const selectedTeamTrimmed = selectedTeam.toLowerCase().trim();
                const conferenceMatch = selectedConference === 'Conference' || match.includes(selectedConferenceTrimmed);
                const teamMatch = selectedTeam === 'School' || match.includes(selectedTeamTrimmed);

                // Convert row.date to a Date object
                const rowDate = new Date(row.date);

                // Check if the rowDate is within the selected range
                const dateMatch = (!startDate || rowDate >= new Date(startDate)) &&
                    (!endDate || rowDate <= new Date(endDate));

                return conferenceMatch && teamMatch && dateMatch;
            });

            populateScheduleTable(filteredData);
        }

        function splitLine(line) {
            const result = [];
            let currentField = '';
            let inQuotes = false;
            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            result.push(currentField.trim());
            return result;
        }

        document.getElementById('conference-schedule-dropdown').addEventListener('change', filterTable);
        document.getElementById('teams-schedule-dropdown').addEventListener('change', filterTable);
        document.getElementById('startDate').addEventListener('change', filterTable);
        document.getElementById('endDate').addEventListener('change', filterTable);

        document.addEventListener('DOMContentLoaded', fetchScheduleData);
    </script>

    <!-- Script to run teams tab -->
    <script>
        let allTeamRows = [];

        // Function to add http to URLs
        function ensureProtocol(url) {
            if (!/^https?:\/\//i.test(url)) {
                return 'http://' + url;
            }
            return url;
        }

        // Fetch the CSV file from the GitHub raw URL
        fetch('https://raw.githubusercontent.com/widbuntu/vbdb-info/main/data/teams.csv')
            .then(response => response.text())
            .then(csvData => {
                const rows = csvData.split('\n');
                const table = document.getElementById('teamsTable');
                const tbody = table.querySelector('tbody');

                // Process the rest of the rows as data
                rows.slice(1).forEach(row => {
                    const rowData = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    if (!rowData || rowData.length < 5) return; // Ensure valid row data
                    const tr = document.createElement('tr');

                    rowData.forEach((cell, index) => {
                        const cellElement = document.createElement('td');
                        cell = cell.trim().replace(/^"|"$/g, '');

                        // If the cell is the URL column, add http if necessary
                        if (index === 2) {
                            cellElement.innerHTML = `<a href="${ensureProtocol(cell)}" target="_blank">${cell}</a>`;
                        } else {
                            cellElement.textContent = cell;
                        }

                        tr.appendChild(cellElement);
                    });

                    tbody.appendChild(tr);
                    allTeamRows.push(tr);
                });
            })
            .catch(error => console.error('Error loading CSV:', error));
    </script>

    <!-- Script to run live tab -->
    <script>
        let liveData = []; // Array to hold the live data

        async function fetchLiveData() {
            const response = await fetch('https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/live.csv');
            const csvText = await response.text();

            // Split into rows and filter out empty lines
            const rows = csvText.split('\n').filter(row => row.trim() !== '');
            const dataRows = rows.slice(1); // Ignore the header row

            // Parse each row into an object
            liveData = dataRows.map(row => {
                const fields = row.split(','); // Split by comma
                return {
                    date: fields[0] || '',
                    match: fields[1] || '',
                    results: fields[2] || '',
                };
            });

            // Log the parsed data for debugging
            console.log('Live Data:', liveData);

            // Populate the table with the fetched data
            populateLiveTable(liveData);
        }

        // Function to populate the live scores table
        function populateLiveTable(data) {
            const tbody = document.querySelector('#liveTable tbody');
            tbody.innerHTML = ''; // Clear existing rows

            // Insert each row into the table
            data.forEach(row => {
                const rowElement = document.createElement('tr');
                rowElement.innerHTML = `
                    <td>${row.date.trim()}</td>
                    <td>${row.match.trim()}</td>
                    <td>${row.results.trim()}</td>
                `;
                tbody.appendChild(rowElement);
            });
        }

        // Fetch and display live data when the page loads
        window.onload = fetchLiveData;
    </script>

    <!-- Script to run rankings tab -->
    <script>
        let rankingsData = [];
        let currentSortColumn = '';
        let isAscending = true;

        async function fetchRankingData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/fig_stats.csv');
                const csvText = await response.text();
                const rows = csvText.split('\n').filter(row => row.trim() !== '');
                const dataRows = rows.slice(1);
                rankingsData = dataRows.map(row => {
                    const fields = row.split(',');
                    return {
                        RPI: fields[0] || '',
                        Team: fields[1] || '',
                        Conf: fields[2] || '',
                        RpiPct: parseFloat(fields[3]) || 0,
                        'W-L': fields[4] || '',
                        Top25: parseInt(fields[5]) || 0,
                        Top50: parseInt(fields[6]) || 0,
                        ConfRec: fields[7] || '',
                        NonConf: fields[8] || '',
                        OppRcrd: fields[9] || '',
                        SosPct: parseFloat(fields[10]) || 0,
                        Rnk: parseInt(fields[11]) || 0,
                        Home: fields[12] || '',
                        Away: fields[13] || '',
                        Neut: fields[14] || '',
                        Tp100: parseInt(fields[15]) || 0,
                        '100-2': parseInt(fields[16]) || 0,
                        '200-': parseInt(fields[17]) || 0,
                        SetsWon: parseInt(fields[18]) || 0,
                        GdW: parseInt(fields[19]) || 0,
                        BdL: parseInt(fields[20]) || 0
                    };
                });
                populateRankingTable(rankingsData);
                populateDropdowns();
                addSortListeners();
                addFilterListeners();
            } catch (error) {
                console.error('Error fetching ranking data:', error);
            }
        }

        function populateRankingTable(data) {
            const tbody = document.querySelector('#rankingsTable tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const rowElement = document.createElement('tr');
                rowElement.innerHTML = `
                    <td>${row.RPI}</td>
                    <td>${row.Team}</td>
                    <td>${row.Conf}</td>
                    <td>${row.RpiPct.toFixed(3)}</td>
                    <td>${row['W-L']}</td>
                    <td>${row.Top25}</td>
                    <td>${row.Top50}</td>
                    <td>${row.ConfRec}</td>
                    <td>${row.NonConf}</td>
                    <td>${row.OppRcrd}</td>
                    <td>${row.SosPct.toFixed(3)}</td>
                    <td>${row.Rnk}</td>
                    <td>${row.Home}</td>
                    <td>${row.Away}</td>
                    <td>${row.Neut}</td>
                    <td>${row.Tp100}</td>
                    <td>${row['100-2']}</td>
                    <td>${row['200-']}</td>
                    <td>${row.SetsWon}</td>
                    <td>${row.GdW}</td>
                    <td>${row.BdL}</td>
                `;
                tbody.appendChild(rowElement);
            });
        }

        function populateDropdowns() {
            const conferenceDropdown = document.getElementById('conference-ranking-dropdown');
            const teamDropdown = document.getElementById('teams-ranking-dropdown');

            const conferences = [...new Set(rankingsData.map(item => item.Conf))].sort();
            const teams = [...new Set(rankingsData.map(item => item.Team))].sort();

            conferences.forEach(conf => {
                const option = document.createElement('option');
                option.value = conf;
                option.textContent = conf;
                conferenceDropdown.appendChild(option);
            });

            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamDropdown.appendChild(option);
            });
        }

        function addSortListeners() {
            const headers = document.querySelectorAll('#rankingsTable th');
            headers.forEach((header, index) => {
                header.addEventListener('click', () => {
                    const column = Object.keys(rankingsData[0])[index];
                    sortTable(column);
                });
            });
        }

        function addFilterListeners() {
            const conferenceDropdown = document.getElementById('conference-ranking-dropdown');
            const teamDropdown = document.getElementById('teams-ranking-dropdown');

            conferenceDropdown.addEventListener('change', filterTable);
            teamDropdown.addEventListener('change', filterTable);
        }

        function filterTable() {
            const selectedConference = document.getElementById('conference-ranking-dropdown').value;
            const selectedTeam = document.getElementById('teams-ranking-dropdown').value;

            const filteredData = rankingsData.filter(row => {
                return (selectedConference === '' || row.Conf === selectedConference) &&
                    (selectedTeam === '' || row.Team === selectedTeam);
            });

            populateRankingTable(filteredData);
        }

        function sortTable(column) {
            if (currentSortColumn === column) {
                isAscending = !isAscending;
            } else {
                isAscending = true;
            }
            currentSortColumn = column;

            rankingsData.sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];

                if (column === 'RPI') {
                    aValue = parseInt(aValue);
                    bValue = parseInt(bValue);
                }

                if (aValue < bValue) return isAscending ? -1 : 1;
                if (aValue > bValue) return isAscending ? 1 : -1;
                return 0;
            });

            filterTable(); // Apply filters after sorting

            document.querySelectorAll('#rankingsTable th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const currentHeader = document.querySelector(`#rankingsTable th:nth-child(${Object.keys(rankingsData[0]).indexOf(column) + 1})`);
            currentHeader.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
        }

        window.onload = fetchRankingData;
    </script>

</body>

</html>