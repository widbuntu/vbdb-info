<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VBDB</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
    <link rel="stylesheet" href="styles/styles.css" />
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
</head>

<body>
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main -->
    <div class="container mt-5">

        <!-- Nav Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="vbdb-tab" data-bs-toggle="tab" data-bs-target="#vbdb" type="button"
                    role="tab" aria-controls="vbdb" aria-selected="true">
                    VBDB
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="live-tab" data-bs-toggle="tab" data-bs-target="#live" type="button"
                    role="tab" aria-controls="live" aria-selected="false">
                    Live
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button"
                    role="tab" aria-controls="schedule" aria-selected="false">
                    Results
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rankings-tab" data-bs-toggle="tab" data-bs-target="#rankings" type="button"
                    role="tab" aria-controls="rankings" aria-selected="false">
                    Rankings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button"
                    role="tab" aria-controls="teams" aria-selected="false">
                    Teams
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="players-tab" data-bs-toggle="tab" data-bs-target="#players" type="button"
                    role="tab" aria-controls="players" aria-selected="false">
                    Players
                </button>
            </li>
        </ul>

        <!-- Main Div for tabs content -->
        <div class="tab-content" id="myTabContent">
            <!-- Home tab -->
            <div class="tab-pane fade show active" id="vbdb" role="tabpanel" aria-labelledby="vbdb-tab">
                <h2 class="text-center">VBDB Content</h2>
                <p class="text-center">Welcome to VBDB!</p>
                <p class="text-center">Scores and Rankings updates for NCAA
                    Division I Women's Volleyball!</p>
                <hr>
                <h2 class="text-center">Data Downloads</h2>
                <p class="text-center"><a style="color: white; text-decoration: underline" target="_blank"
                        href="https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/teams.csv">Teams</a>
                </p>
                <p class="text-center"><a style="color: white; text-decoration: underline" target="_blank"
                        href="https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/test_sch.csv">Results</a>
                </p>
                <p class="text-center"><a style="color: white; text-decoration: underline" target="_blank"
                        href="https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/fig_stats.csv">Rankings</a>
                </p>
                <p class="text-center"><a style="color: white; text-decoration: underline" target="_blank"
                        href="https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/players.csv">Players</a>
                </p>

                <hr>
                <h2 class="text-center">Data Sources</h2>
                <p class="text-center">https://stats.ncaa.org</p>
                <p class="text-center">https://ncaastats.figstats.net/volleyball-rpi.cgi</p>
                <p class="text-center">https://www.ncaa.com/rankings/volleyball-women/d1/ncaa-womens-volleyball-rpi</p>
            </div>

            <!-- Live tab -->
            <div class="tab-pane fade" id="live" role="tabpanel" aria-labelledby="live-tab">
                <h2 class="text-center">Live Scores</h2>
                <!-- Dropdown for Searchs -->
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="conference-live-dropdown"
                                id="conference-live-dropdown">
                                <option value>Conference</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive" style="overflow-x: auto">
                    <table id="liveTable" class="table table-dark table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Match</th>
                                <th>Results</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- We'll fill this with rows of data from the CSV -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Results tab -->
            <div class="tab-pane fade" id="schedule" role="tabpanel" aria-labelledby="schedule-tab">
                <h2 class="text-center">Results 2024</h2>

                <!-- Dropdown for Searchs -->
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="conference-schedule-dropdown"
                                id="conference-schedule-dropdown">
                                <option value="Conference">Conference</option>
                            </select>
                        </div>
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="teams-schedule-dropdown"
                                id="teams-schedule-dropdown">
                                <option selected>School</option>
                            </select>
                        </div>
                        <div class="col-auto mb-3">
                            <input id="startDate" class="form-control form-select-sm" type="date" />
                            <span id="startDateSelected"></span>
                        </div>
                        <div class="col-auto mb-3">
                            <input id="endDate" class="form-control form-select-sm" type="date" />
                            <span id="endDateSelected"></span>
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="table-responsive" style="overflow-x: auto">
                    <table id="schTable" class="table table-dark table-hover table-striped w-100">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Match</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- CSV Portion -->
                        </tbody>
                    </table>
                </div>

            </div>

            <!-- Teams tab -->
            <div class="tab-pane fade" id="teams" role="tabpanel" aria-labelledby="teams-tab">
                <h2 class="text-center">NCAA D1 Schools</h2>
                <div class="table-responsive">
                    <table id="teamsTable" class="table table-dark table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>Conference</th>
                                <th>School URL</th>
                                <th>Conference Full</th>
                                <th>Division</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Fill this with rows of data from the CSV -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Rankings tab -->
            <div class="tab-pane fade" id="rankings" role="tabpanel" aria-labelledby="rankings-tab">
                <h2 class="text-center">Rankings</h2>
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="conference-ranking-dropdown"
                                id="conference-ranking-dropdown">
                                <option value>All Conferences</option>
                            </select>
                        </div>
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="teams-ranking-dropdown"
                                id="teams-ranking-dropdown" disabled hidden>
                                <option value>All Teams</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="overflow-x: auto">
                    <table id="rankingsTable" class="table table-dark table-hover table-striped w-100">
                        <thead>
                            <tr>
                                <th>Team</th>
                                <th>Conf</th>
                                <th>W</th>
                                <th>L</th>
                                <th>ConfRec</th>
                                <th>FigStats RPI</th>
                                <th>NCAA Rank</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- CSV Portion -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Players tab -->
            <div class="tab-pane fade" id="players" role="tabpanel" aria-labelledby="players-tab">
                <h2 class="text-center">Players</h2>
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="conference-players-dropdown"
                                id="conference-players-dropdown">
                                <option value>All Conferences</option>
                            </select>
                        </div>
                        <div class="col-auto mb-3">
                            <select class="form-select form-select-sm" name="teams-players-dropdown"
                                id="teams-players-dropdown">
                                <option value>All Teams</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="overflow-x: auto">
                    <table id="playersTable" class="table table-dark table-hover table-striped w-100">
                        <thead>
                            <tr>
                                <th>Number</th>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Position</th>
                                <th>Height</th>
                                <th>Hometown</th>
                                <th>High School</th>
                                <th style="width: 200px;">Team</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- CSV Portion -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- End of content -->
        </div>

    </div>

    <!-- Scripts -->

    <!-- Script to populate dropdowns -->
    <script>
        let teamData = []; // To store the team data globally
        let scheduleData = []; // Store schedule data

        // Function to split a line, accounting for quoted fields
        function splitLine(line) {
            const result = [];
            let currentField = "";
            let inQuotes = false;

            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes; // Toggle quote state
                } else if (char === "," && !inQuotes) {
                    result.push(currentField.trim()); // Push field and reset
                    currentField = "";
                } else {
                    currentField += char; // Accumulate characters in current field
                }
            }

            result.push(currentField.trim()); // Push the last field
            return result;
        }

        async function fetchData() {
            const response = await fetch(
                "https://raw.githubusercontent.com/widbuntu/vbdb-info/main/data/teams2.csv"
            );
            const csvText = await response.text();

            // Split the CSV into rows
            const rows = csvText.split("\n");
            const dataRows = rows.slice(1); // Data rows (ignoring the header)

            const conferenceNames = new Set(); // Use a Set to store unique conference names

            // Parse each data row
            dataRows.forEach((row) => {
                const fields = splitLine(row); // Assuming splitLine correctly handles CSV

                if (fields.length >= 6) {
                    // Ensure we have all required columns
                    const conferenceName = fields[1]; // Full conference name (column index 1)
                    const teamShort = fields[5]; // team_short (column index 5)

                    if (conferenceName) conferenceNames.add(conferenceName);

                    // Store team data in the global teamData array
                    teamData.push({
                        teamShort: teamShort.trim(),
                        conferenceName: conferenceName.trim(),
                    });
                }
            });

            // Populate the conference dropdowns
            const sortedConferenceNames = Array.from(conferenceNames).sort();
            const scheduleDropdown = document.getElementById("conference-schedule-dropdown");

            sortedConferenceNames.forEach((name) => {
                const option = document.createElement("option");
                option.value = name;
                option.textContent = name;
                scheduleDropdown.appendChild(option);
            });

            // Call another function to handle team population based on the selected conference (optional)
            populateTeamsDropdown("Conference");
        }

        function populateTeamsDropdown(conferenceName) {
            const teamsDropdown = document.getElementById("teams-schedule-dropdown");
            teamsDropdown.innerHTML = "<option selected>School</option>"; // Reset the dropdown

            const uniqueTeams = new Set(); // Use a Set to store unique team_short values

            // Filter team data based on selected conference, or show all teams if "Conference" is selected
            teamData.forEach((team) => {
                if (
                    conferenceName === "Conference" ||
                    team.conferenceName === conferenceName
                ) {
                    uniqueTeams.add(team.teamShort);
                }
            });

            // Convert Set to Array and sort it alphabetically
            const sortedTeams = Array.from(uniqueTeams).sort();

            // Populate the teams dropdown with sorted values
            sortedTeams.forEach((team) => {
                const option = document.createElement("option");
                option.value = team;
                option.textContent = team;
                teamsDropdown.appendChild(option);
            });
        }

        document
            .getElementById("conference-schedule-dropdown")
            .addEventListener("change", (event) => {
                const selectedConference = event.target.value;
                if (selectedConference) {
                    populateTeamsDropdown(selectedConference);
                } else {
                    // Reset the teams dropdown if no conference is selected
                    document.getElementById("teams-schedule-dropdown").innerHTML =
                        "<option selected>School</option>";
                }
            });

        // Fetch the data when the page loads
        fetchData();
    </script>

    <!-- Script to populate Results table -->
    <script>
        async function fetchScheduleData() {
            const response = await fetch(
                "https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/test_sch.csv"
            );
            const csvText = await response.text();
            const rows = csvText.split("\n").filter((row) => row.trim() !== "");
            const dataRows = rows.slice(1);

            scheduleData = dataRows.map((row) => {
                const fields = splitLine(row);
                return {
                    date: fields[0] || "",
                    match: fields[1] || "",
                    results: fields[2] || "",
                    box_score_url: fields[3] || "",
                };
            });

            console.log("Schedule Data:", scheduleData);
            populateScheduleTable(scheduleData);
            populateConferenceDropdown();
        }

        function populateScheduleTable(data) {
            const tbody = document.querySelector("#schTable tbody");
            tbody.innerHTML = "";
            data.sort((a, b) => new Date(a.date) - new Date(b.date));
            data.forEach((row) => {
                const { winner, matchHTML } = formatMatch(row.match, row.results);

                const rowElement = document.createElement("tr");
                rowElement.innerHTML = `
                    <td style="width:2%">${row.date.trim()}</td>
                    <td style="width:15%">${matchHTML}</td>
                    <td style="width:25%">${row.results.trim()} <a href="${row.box_score_url.trim()}" target="_blank">View</a></td>
                `;
                tbody.appendChild(rowElement);
            });
        }

        function formatMatch(match, results) {
            const setWins = results.match(/\[(\d+)-(\d+)\]/); // Extract set wins like [3-0] or [2-3]
            if (!setWins) return { winner: "", matchHTML: match }; // If results are not formatted as expected, return the match as is

            const team1SetWins = parseInt(setWins[1]);
            const team2SetWins = parseInt(setWins[2]);

            const [team1, team2] = match.split(" vs "); // Split the teams

            let winner, matchHTML;

            if (team1SetWins > team2SetWins) {
                // Team 1 is the winner
                winner = team1.trim();
                matchHTML = `<strong class="text-info" style="--bs-text-opacity: .75;">${team1.trim()}</strong> vs ${team2.trim()}`;
            } else {
                // Team 2 is the winner
                winner = team2.trim();
                matchHTML = `${team1.trim()} vs <strong class="text-info" style="--bs-text-opacity: .75;">${team2.trim()}</strong>`;
            }

            return { winner, matchHTML };
        }

        function populateConferenceDropdown() {
            const conferenceDropdown = document.getElementById("conference-schedule-dropdown");

            // Extract conference names, remove empty strings, and sort them
            const conferenceNames = [...new Set(teamData.map((team) => team.conferenceName.trim()))]
                .filter(conference => conference) // Filter out empty or undefined values
                .sort();

            // Clear the conference dropdown
            conferenceDropdown.innerHTML = '<option value="Conference">Conference</option>';

            // Populate the conference dropdown with the extracted and filtered conference names
            conferenceNames.forEach((conference) => {
                const option = document.createElement("option");
                option.value = conference;
                option.textContent = conference;
                conferenceDropdown.appendChild(option);
            });
        }

        function populateTeamsDropdown(conferenceName) {
            const teamsDropdown = document.getElementById("teams-schedule-dropdown");
            teamsDropdown.innerHTML = "<option selected>School</option>"; // Reset the dropdown

            const uniqueTeams = new Set(); // Use a Set to store unique team_short values

            // Filter team data based on selected conference, or show all teams if "Conference" is selected
            teamData.forEach((team) => {
                if (
                    conferenceName === "Conference" ||
                    team.conferenceName === conferenceName
                ) {
                    uniqueTeams.add(team.teamShort);
                }
            });

            // Convert Set to Array and sort it alphabetically
            const sortedTeams = Array.from(uniqueTeams).sort();

            // Populate the teams dropdown with sorted values
            sortedTeams.forEach((team) => {
                const option = document.createElement("option");
                option.value = team;
                option.textContent = team;
                teamsDropdown.appendChild(option);
            });
        }

        function filterTable() {
            const selectedConference = document.getElementById(
                "conference-schedule-dropdown"
            ).value;
            const selectedTeam = document.getElementById(
                "teams-schedule-dropdown"
            ).value;
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;

            const filteredData = scheduleData.filter((row) => {
                const match = row.match;
                const selectedConferenceTrimmed = selectedConference
                    .trim();
                const selectedTeamTrimmed = selectedTeam.trim();
                const conferenceMatch =
                    selectedConference === "Conference" ||
                    match.includes(selectedConferenceTrimmed);
                const teamMatch =
                    selectedTeam === "School" || match.includes(selectedTeamTrimmed);

                // Convert row.date to a Date object
                const rowDate = new Date(row.date);

                // Check if the rowDate is within the selected range
                const dateMatch =
                    (!startDate || rowDate >= new Date(startDate)) &&
                    (!endDate || rowDate <= new Date(endDate));

                return conferenceMatch && teamMatch && dateMatch;
            });

            populateScheduleTable(filteredData);
        }

        function splitLine(line) {
            const result = [];
            let currentField = "";
            let inQuotes = false;
            for (let char of line) {
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === "," && !inQuotes) {
                    result.push(currentField.trim());
                    currentField = "";
                } else {
                    currentField += char;
                }
            }
            result.push(currentField.trim());
            return result;
        }

        document
            .getElementById("conference-schedule-dropdown")
            .addEventListener("change", filterTable);
        document
            .getElementById("teams-schedule-dropdown")
            .addEventListener("change", filterTable);
        document
            .getElementById("startDate")
            .addEventListener("change", filterTable);
        document
            .getElementById("endDate")
            .addEventListener("change", filterTable);

        document.addEventListener("DOMContentLoaded", fetchScheduleData);
    </script>

    <!-- Script to run teams tab -->
    <script>
        let allTeamRows = [];

        // Function to add http to URLs
        function ensureProtocol(url) {
            if (!/^https?:\/\//i.test(url)) {
                return "http://" + url;
            }
            return url;
        }

        // Fetch the CSV file from the GitHub raw URL
        fetch(
            "https://raw.githubusercontent.com/widbuntu/vbdb-info/main/data/teams.csv"
        )
            .then((response) => response.text())
            .then((csvData) => {
                const rows = csvData.split("\n");
                const table = document.getElementById("teamsTable");
                const tbody = table.querySelector("tbody");

                // Process the rest of the rows as data
                rows.slice(1).forEach((row) => {
                    const rowData = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                    if (!rowData || rowData.length < 5) return; // Ensure valid row data
                    const tr = document.createElement("tr");

                    rowData.forEach((cell, index) => {
                        const cellElement = document.createElement("td");
                        cell = cell.trim().replace(/^"|"$/g, "");

                        // If the cell is the URL column, add http if necessary
                        if (index === 2) {
                            cellElement.innerHTML = `<a href="${ensureProtocol(
                                cell
                            )}" target="_blank">${cell}</a>`;
                        } else {
                            cellElement.textContent = cell;
                        }

                        tr.appendChild(cellElement);
                    });

                    tbody.appendChild(tr);
                    allTeamRows.push(tr);
                });
            })
            .catch((error) => console.error("Error loading CSV:", error));
    </script>

    <!-- Script to run live tab -->
    <script>
        let allLiveData = [];
        let fetchInterval;

        function populateTable(data) {
            const tbody = document.querySelector("#liveTable tbody");
            tbody.innerHTML = "";
            data.forEach((row) => {
                const rowElement = document.createElement("tr");
                rowElement.innerHTML = `
        <td style="width:15%">${row.match.trim()}</td>
        <td style="width:25%">${row.results.trim()} <a href="${row.box_score_url.trim()}" target="_blank">View</a></td>
    `;
                tbody.appendChild(rowElement);
            });
        }

        function populateDropdown(data) {
            const dropdown = document.getElementById('conference-live-dropdown');
            const conferences = new Set();

            data.forEach(item => {
                const match = item.match;
                const conferenceRegex = /\(([^)]+)\)/g;
                let match_;
                while ((match_ = conferenceRegex.exec(match)) !== null) {
                    conferences.add(match_[1].trim());
                }
            });

            // Sort conferences alphabetically
            const sortedConferences = Array.from(conferences).sort();

            // Clear existing options (except the default one)
            dropdown.innerHTML = '<option value="">Conference</option>';

            sortedConferences.forEach(conference => {
                const option = document.createElement('option');
                option.value = conference;
                option.textContent = conference;
                dropdown.appendChild(option);
            });
        }

        function filterTable() {
            const selectedConference = document.getElementById('conference-live-dropdown').value;
            console.log('Selected conference:', selectedConference);  // Debugging

            let filteredData;

            if (selectedConference === '') {
                filteredData = allLiveData;  // No filtering
            } else {
                filteredData = allLiveData.filter(item => {
                    const matchConferenceRegex = /\(([^)]+)\)/g;
                    let matchConference;
                    let found = false;
                    while ((matchConference = matchConferenceRegex.exec(item.match)) !== null) {
                        console.log('Found conference:', matchConference[1].trim());  // Debugging
                        if (matchConference[1].trim().toLowerCase() === selectedConference.toLowerCase()) {
                            found = true;
                            break;
                        }
                    }
                    return found;
                });
            }

            console.log('Filtered data:', filteredData);  // Debugging
            populateTable(filteredData);
        }

        function fetchDataAndPopulate() {
            // Capture the currently selected conference
            const selectedConference = document.getElementById('conference-live-dropdown').value;

            fetch('https://test-api-42b6a9daeff2.herokuapp.com/')
                .then(response => response.json())
                .then(data => {
                    allLiveData = data.data;  // Store all data globally

                    // Repopulate the table and dropdown
                    populateTable(allLiveData);
                    populateDropdown(allLiveData);

                    // Reapply the filter
                    document.getElementById('conference-live-dropdown').value = selectedConference;
                    filterTable();  // Apply the filter to show the filtered data again

                    console.log('Data refreshed at', new Date().toLocaleTimeString());
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    const tableBody = document.querySelector('#liveTable tbody');
                    tableBody.innerHTML = '<tr><td colspan="3">Error loading data. Please try again later.</td></tr>';
                });
        }

        function startPeriodicFetch() {
            // Fetch immediately on start
            fetchDataAndPopulate();

            // Then fetch every 45 seconds
            fetchInterval = setInterval(fetchDataAndPopulate, 45000);
        }

        function stopPeriodicFetch() {
            clearInterval(fetchInterval);
        }

        // Call the function to start periodic fetching when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            startPeriodicFetch();

            // Add event listener to the dropdown
            document.getElementById('conference-live-dropdown').addEventListener('change', filterTable);
        });

        // Optional: Stop fetching when the page is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopPeriodicFetch();
            } else {
                startPeriodicFetch();
            }
        });


    </script>

    <!-- Script to run rankings tab -->
    <script>
        let rankingsData = [];
        let currentSortColumn = "";
        let isAscending = true;

        async function fetchRankingData() {
            try {
                const response = await fetch(
                    "https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/fig_stats.csv"
                );
                const csvText = await response.text();
                const rows = csvText.split("\n").filter((row) => row.trim() !== "");
                const dataRows = rows.slice(1);
                rankingsData = dataRows.map((row) => {
                    const fields = row.split(",");
                    return {
                        Team: fields[0] || "",
                        Conf: fields[4] || "",
                        "W": parseInt(fields[1]) || 0,
                        "L": parseInt(fields[2]) || 0,
                        ConfRec: fields[3] || 0,
                        "FigStats RPI": parseInt(fields[5]) || 0,
                        "NCAA Rank": parseInt(fields[6]) || 0,
                    };
                });
                populateRankingTable(rankingsData);
                populateRankingDropdowns();
                addRankingSortListeners();
                addRankingsFilterListeners();
            } catch (error) {
                console.error("Error fetching ranking data:", error);
            }
        }

        function populateRankingTable(data) {
            const tbody = document.querySelector("#rankingsTable tbody");
            tbody.innerHTML = "";
            data.forEach((row) => {
                const rowElement = document.createElement("tr");
                rowElement.innerHTML = `
                    <td>${row.Team}</td>
                    <td>${row.Conf}</td>
                    <td>${row.W}</td>
                    <td>${row.L}</td>
                    <td>${row.ConfRec}</td>
                    <td>${row["FigStats RPI"]}</td>
                    <td>${row["NCAA Rank"]}</td>
                `;
                tbody.appendChild(rowElement);
            });
        }

        function populateRankingDropdowns() {
            const conferenceDropdown = document.getElementById(
                "conference-ranking-dropdown"
            );
            const conferences = [
                ...new Set(rankingsData.map((item) => item.Conf)),
            ].sort();
            const teams = [
                ...new Set(rankingsData.map((item) => item.Team)),
            ].sort();

            conferences.forEach((conf) => {
                const option = document.createElement("option");
                option.value = conf;
                option.textContent = conf;
                conferenceDropdown.appendChild(option);
            });

        }

        function addRankingSortListeners() {
            const headers = document.querySelectorAll("#rankingsTable th");
            headers.forEach((header, index) => {
                header.addEventListener("click", () => {
                    const column = Object.keys(rankingsData[0])[index];
                    sortRankingTable(column);
                });
            });
        }

        function addRankingsFilterListeners() {
            const conferenceDropdown = document.getElementById("conference-ranking-dropdown");
            const teamDropdown = document.getElementById("teams-ranking-dropdown");

            // Enable team dropdown based on selected conference
            conferenceDropdown.addEventListener("change", () => {
                const selectedConference = conferenceDropdown.value;
                populateTeamDropdown(selectedConference); // Populate teams based on selected conference
                filterRankingTable(); // Filter table when conference changes
            });

            teamDropdown.addEventListener("change", filterRankingTable); // Call the filter function for teams
        }

        function populateTeamDropdown(selectedConference) {
            const teamDropdown = document.getElementById("teams-ranking-dropdown");
            teamDropdown.innerHTML = ""; // Clear existing options
            teamDropdown.disabled = false; // Enable the dropdown

            const teams = [...new Set(rankingsData
                .filter(item => selectedConference === "" || item.Conf === selectedConference)
                .map(item => item.Team))].sort();

            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "All Teams";
            teamDropdown.appendChild(defaultOption);

            teams.forEach((team) => {
                const option = document.createElement("option");
                option.value = team;
                option.textContent = team;
                teamDropdown.appendChild(option);
            });
        }

        function filterRankingTable() {
            const selectedRankingConference = document.getElementById("conference-ranking-dropdown").value;
            const selectedRankingTeam = document.getElementById("teams-ranking-dropdown").value;

            const filteredData = rankingsData.filter((row) => {
                return (
                    (selectedRankingConference === "" || row.Conf === selectedRankingConference) &&
                    (selectedRankingTeam === "" || row.Team === selectedRankingTeam)
                );
            });

            populateRankingTable(filteredData);
        }

        function sortRankingTable(column) {
            if (currentSortColumn === column) {
                isAscending = !isAscending;
            } else {
                isAscending = true;
            }
            currentSortColumn = column;

            rankingsData.sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];

                if (column === "RPI") {
                    aValue = parseInt(aValue);
                    bValue = parseInt(bValue);
                }

                if (aValue < bValue) return isAscending ? -1 : 1;
                if (aValue > bValue) return isAscending ? 1 : -1;
                return 0;
            });

            filterRankingTable(); // Apply filters after sorting

            document.querySelectorAll("#rankingsTable th").forEach((th) => {
                th.classList.remove("sort-asc", "sort-desc");
            });
            const currentHeader = document.querySelector(
                `#rankingsTable th:nth-child(${Object.keys(rankingsData[0]).indexOf(column) + 1
                })`
            );
            currentHeader.classList.add(isAscending ? "sort-asc" : "sort-desc");
        }

        window.onload = fetchRankingData;
    </script>

    <!-- Script to prefill date -->
    <script>
        // Function to format date as YYYY-MM-DD
        function getFormattedDate(date, minusDays) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed
            const day = String(date.getDate() - minusDays).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Set the default date to today's date
        const today = new Date();
        document.getElementById("startDate").value = getFormattedDate(today, 6);
        document.getElementById("endDate").value = getFormattedDate(today, 1);
    </script>

    <!-- Script to populate Players table -->
    <script>
        // Parse CSV data
        const parseCSV = (csv) => {
            const lines = csv.split('\n');
            return lines.slice(1).filter(line => line.trim() !== '').map(line => {
                const fields = splitLine(line);
                return {
                    No: fields[0] || "",
                    Name: fields[1] || "",
                    Class: fields[2] || "",
                    Position: fields[3] || "",
                    Height: fields[4] || "",
                    Hometown: fields[5] || "",
                    'High School': fields[6] || "",
                    conference_name: fields[7] || "",
                    team_short: fields[8] || ""
                };
            });
        };

        // Fetch and process CSV data
        async function fetchAndProcessData() {
            try {
                const response = await fetch("https://raw.githubusercontent.com/widbuntu/vbdb-info/refs/heads/main/data/players.csv");
                const csvData = await response.text();
                const players = parseCSV(csvData);
                initializeTable(players);
            } catch (error) {
                console.error("Error fetching or parsing CSV data:", error);
            }
        }

        function initializeTable(players) {
            const conferenceDropdown = document.getElementById('conference-players-dropdown');
            const teamDropdown = document.getElementById('teams-players-dropdown');
            const playersTable = document.getElementById('playersTable');

            // Populate conference dropdown
            const uniqueConferences = [...new Set(players.map(player => player.conference_name).filter(conference => conference.trim() !== ''))].sort();

            conferenceDropdown.innerHTML = '<option value="">All Conferences</option>';
            uniqueConferences.forEach(conference => {
                const option = document.createElement('option');
                option.value = conference;
                option.textContent = conference;
                conferenceDropdown.appendChild(option);
            });

            // Handle conference selection
            conferenceDropdown.addEventListener('change', (e) => {
                const selectedConference = e.target.value;

                // Filter teams based on the selected conference
                let filteredTeams;
                if (selectedConference === '') {
                    // If "All Conferences" is selected, show all teams with a conference affiliation
                    filteredTeams = players
                        .filter(player => player.conference_name.trim() !== '') // Exclude teams with no conference affiliation
                        .map(player => player.team_short);
                } else {
                    // Otherwise, show teams only from the selected conference
                    filteredTeams = players
                        .filter(player => player.conference_name === selectedConference)
                        .map(player => player.team_short);
                }

                const uniqueTeams = [...new Set(filteredTeams)].sort();

                // Clear and repopulate team dropdown
                teamDropdown.innerHTML = '<option value="">All Teams</option>';
                uniqueTeams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.textContent = team;
                    teamDropdown.appendChild(option);
                });

                updateTable();
            });

            // Handle team selection
            teamDropdown.addEventListener('change', updateTable);

            // Update table based on selections
            function updateTable() {
                const selectedConference = conferenceDropdown.value;
                const selectedTeam = teamDropdown.value;

                const filteredPlayers = players.filter(player =>
                    (selectedConference === '' || player.conference_name === selectedConference) &&
                    (selectedTeam === '' || player.team_short === selectedTeam)
                );

                const tbody = playersTable.querySelector('tbody');
                tbody.innerHTML = '';

                // Sort by team first, then by number (No)
                filteredPlayers.sort((a, b) => {
                    // First, compare team names
                    const teamComparison = a.team_short.localeCompare(b.team_short);

                    // If teams are the same, compare by number
                    if (teamComparison === 0) {
                        return parseInt(a.No) - parseInt(b.No);
                    }

                    // Otherwise, return the team comparison
                    return teamComparison;
                });

                // Populate table with sorted players
                filteredPlayers.forEach(player => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = player.No;
                    row.insertCell().textContent = player.Name;
                    row.insertCell().textContent = player.Class;
                    row.insertCell().textContent = player.Position;
                    row.insertCell().textContent = player.Height;
                    row.insertCell().textContent = player.Hometown;
                    row.insertCell().textContent = player['High School'];
                    row.insertCell().textContent = player.team_short;
                });
            }

            // Implement sorting
            playersTable.querySelector('thead').addEventListener('click', (e) => {
                if (e.target.tagName === 'TH') {
                    const headerIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
                    const isAscending = e.target.classList.toggle('asc'); // Toggle the 'asc' class to determine sort direction
                    const tbody = playersTable.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));

                    // Sort rows based on the clicked header
                    rows.sort((a, b) => {
                        const aValue = a.cells[headerIndex].textContent;
                        const bValue = b.cells[headerIndex].textContent;

                        if (headerIndex === 0) { // Sort 'No' column as integers
                            return isAscending ?
                                parseInt(aValue) - parseInt(bValue) :
                                parseInt(bValue) - parseInt(aValue);
                        } else { // Sort other columns as strings
                            return isAscending ?
                                aValue.localeCompare(bValue) :
                                bValue.localeCompare(aValue);
                        }
                    });

                    tbody.append(...rows);

                    // Handle CSS classes for sorting
                    const headers = playersTable.querySelectorAll('th');
                    headers.forEach(th => {
                        th.classList.remove("sort-asc", "sort-desc"); // Remove sorting classes from all headers
                    });

                    // Apply sorting class to the clicked header
                    e.target.classList.add(isAscending ? "sort-asc" : "sort-desc");
                }
            });

            // Initial table population
            updateTable();
        }

        // Call the function to fetch and process data
        fetchAndProcessData();
    </script>

</body>

</html>